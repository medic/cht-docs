<!-- kapa.ai Assistant Integration. Documentation: https://docs.kapa.ai/integrations/website-widget/installation/general -->

<!-- Preinitialize Kapa to queue calls until widget is ready -->
<script>
(function () {
  'use strict';
  var k = window.Kapa;
  if (!k) {
    var i = function () {
      i.c(arguments);
    };
    i.q = [];
    i.c = function (args) {
      i.q.push(args);
    };
    window.Kapa = i;
  }
})();
</script>

<!-- Kapa Widget Configuration -->
<script
  async
  src="https://widget.kapa.ai/kapa-widget.bundle.js"
  data-website-id="de260d96-3c0b-4ddd-a7e5-8013809dfb12"
  data-project-name="Community Health Toolkit"
  data-project-color="#41AFAF"
  data-project-logo="https://docs.communityhealthtoolkit.org/logo.png"
  data-font-family="Noto Sans,sans-serif"
  data-modal-disclaimer="This is a custom LLM for Community Health Toolkit (CHT) with access to all [Documentation](https://docs.communityhealthtoolkit.org), [GitHub Issues and READMEs](https://github.com/medic/cht-core) and the [CHT Forum](https://forum.communityhealthtoolkit.org). Rate the answers to let us know what you think!"
  data-modal-example-questions="How do I run the CHT locally?,How can I contribute to the CHT?"
  data-button-text-color="#FFFFFF"
  data-modal-header-bg-color="#41AFAF"
  data-modal-title-color="#FFFFFF"
  data-modal-title="CHT Docs AI"
  data-modal-disclaimer-bg-color="#DFEAEA"
  data-modal-disclaimer-text-color="#000000"
  data-modal-ask-ai-input-placeholder="Ask me a question about the CHT..."
  data-consent-required="true"
  data-consent-screen-disclaimer="By clicking &quot;I agree, let's chat&quot;, you consent to the use of the AI assistant in accordance with kapa.ai's [Privacy Policy](https://www.kapa.ai/content/privacy-policy). This service uses reCAPTCHA, which requires your consent to Google's [Privacy Policy](https://policies.google.com/privacy) and [Terms of Service](https://policies.google.com/terms). By proceeding, you explicitly agree to both kapa.ai's and Google's privacy policies."
  data-modal-open-on-command-k="false"
  data-modal-border-radius="6px"
  data-search-mode-enabled="true"
  data-button-hide="true"
></script>

<!-- Custom Kapa AI Button Styles -->
<style>
  #kapa-navbar-btn {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    cursor: pointer;
    border-radius: 0.375rem;
    color: currentColor;
    background-color: transparent;
    border: none;
    transition: background-color 0.15s ease, transform 0.1s ease;
  }

  #kapa-navbar-btn:hover {
    background-color: rgba(0, 0, 0, 0.05);
  }

  .dark #kapa-navbar-btn:hover {
    background-color: rgba(255, 255, 255, 0.1);
  }

  #kapa-navbar-btn:active {
    transform: scale(0.95);
  }
</style>

<!-- Kapa Integration: Navbar Button + Search Intercept -->
<script>
(function() {
  'use strict';

  var KAPA_MODE = {
    AI: 'ai',
    SEARCH: 'search'
  };

  /**
   * Open Kapa modal in specified mode
   * @param {string} mode - 'ai' or 'search'
   * @param {string} [query] - Optional search query
   * @param {boolean} [submit] - Whether to auto-submit the query
   */
  function openKapa(mode, query, submit) {
    var options = { mode: mode };
    if (query !== undefined) {
      options.query = query;
    }
    if (submit !== undefined) {
      options.submit = submit;
    }
    window.Kapa('open', options);
  }

  /**
   * Inject "Ask AI" button into the navbar
   */
  function injectKapaButton() {
    var navbar = document.querySelector('nav.hextra-max-navbar-width');
    if (!navbar || document.getElementById('kapa-navbar-btn')) {
      return;
    }

    var searchWrapper = navbar.querySelector('.hextra-search-wrapper');
    var kapaBtn = document.createElement('button');

    kapaBtn.id = 'kapa-navbar-btn';
    kapaBtn.type = 'button';
    kapaBtn.title = 'Ask AI';
    kapaBtn.innerHTML =
      '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">' +
        '<path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>' +
        '<path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>' +
        '<path d="M19 11h2m-1 -1v2"></path>' +
      '</svg>' +
      '<span class="hx-sr-only">Ask AI</span>';

    if (searchWrapper) {
      navbar.insertBefore(kapaBtn, searchWrapper);
    } else {
      navbar.appendChild(kapaBtn);
    }

    kapaBtn.addEventListener('click', function(e) {
      e.preventDefault();
      openKapa(KAPA_MODE.AI);
    });
  }

  /**
   * Handle keyboard shortcuts globally
   * Ctrl+K / Cmd+K → Ask AI modal
   * Ctrl+L / Cmd+L → Search modal
   */
  function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
      // Ctrl+K / Cmd+K → Ask AI
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        e.stopPropagation();
        openKapa(KAPA_MODE.AI);
      }
      // Ctrl+L / Cmd+L → Search
      if ((e.metaKey || e.ctrlKey) && e.key === 'l') {
        e.preventDefault();
        e.stopPropagation();
        openKapa(KAPA_MODE.SEARCH);
      }
    }, true); // Capture phase to intercept before Hextra
  }

  /**
   * Attach Kapa intercept handlers to a single search input
   * @param {HTMLInputElement} searchInput - The search input element
   */
  function attachSearchIntercept(searchInput) {
    // Mark as processed to avoid duplicate handlers
    if (searchInput.dataset.kapaIntercepted) {
      return;
    }
    searchInput.dataset.kapaIntercepted = 'true';

    // Intercept mousedown to prevent FlexSearch from initializing
    searchInput.addEventListener('mousedown', function(e) {
      e.preventDefault();
      e.stopPropagation();
      openKapa(KAPA_MODE.SEARCH, searchInput.value || '', false);
    });

    // Handle keyboard focus (Tab key)
    searchInput.addEventListener('focus', function() {
      var query = searchInput.value || '';
      searchInput.blur();
      openKapa(KAPA_MODE.SEARCH, query, false);
    });

    // Handle Enter key
    searchInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        openKapa(KAPA_MODE.SEARCH, searchInput.value || '', true);
        searchInput.value = '';
        searchInput.blur();
      }
    });

    searchInput.placeholder = 'Search docs (AI-powered)...';
  }

  /**
   * Intercept all search inputs (desktop + mobile) to use Kapa semantic search
   */
  function setupKapaSearchIntercept() {
    // Find all search inputs (desktop navbar + mobile menu)
    var searchInputs = document.querySelectorAll('.hextra-search-input');
    searchInputs.forEach(attachSearchIntercept);

    // Also observe for dynamically added search inputs (e.g., mobile menu)
    var observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        mutation.addedNodes.forEach(function(node) {
          if (node.nodeType === Node.ELEMENT_NODE) {
            // Check if the added node is a search input
            if (node.classList && node.classList.contains('hextra-search-input')) {
              attachSearchIntercept(node);
            }
            // Check for search inputs within added nodes
            var inputs = node.querySelectorAll ? node.querySelectorAll('.hextra-search-input') : [];
            inputs.forEach(attachSearchIntercept);
          }
        });
      });
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
  }

  /**
   * Initialize all Kapa integrations
   */
  function init() {
    injectKapaButton();
    setupKapaSearchIntercept();
  }

  // Set up keyboard shortcuts immediately (capture phase)
  setupKeyboardShortcuts();

  // Initialize DOM-dependent features
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
